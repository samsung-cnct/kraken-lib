# Security in K2
This document describe what of AuthN/Z is used in K2.
And How to test that.

Currently it uses OIDC Authentication using CoreOS Dex.
It support following authentication backends.
- Github OAuth
- Google OIDC
- LDAP

And RBAC is used for Authorization.

## Architecture
Following images is for understanding AuthN/Z process in K2.
![architecture](image/architecture_1.png)
From above, dex & dex app should be accessible from browser.
And the kube admin should manage user/group records in LDAP.
Also configures proper RBAC policies for each of the records.

Below is sequence of getting/validating auth.
![sequence](image/architecture_2.png)

## Configuration
By default, Auth is disabled in k2.
To enable this see below example in for config.yaml
```yaml
deployment:
  kubeAuth:
    authn:
      oidc:
        service_name: dex
      default_basic_user: admin
      basic:
      - user: admin
        password: secret
    authz:
      rbac:
        super_user: admin
```
From above,
for authentication, it uses 'dex' for oidc provider.
for Authorization, it uses RBAC.

The user 'admin' is basic authentication user has password 'secret'.
It is default user so will be set to kubeConfig file.
It is also RBAC super user, so has permission to manage RBAC policies.

Below is example service configuration.
```yaml
  clusterServices:
    repos:
    - name: atlas
      url: http://atlas.cnct.io
    services:
    - name: openldap
      repo: atlas
      chart: openldap
      version: 0.1.0
      namespace: kube-auth
      values:
        OpenLdap:
          Domain: local.io
          AdminPassword: admin
    - name: dex
      repo: atlas
      chart: dex
      version: 0.1.0
      namespace: kube-auth
      values:
        DexApp:
          RedirectUri: http://auth.keyolk.cluster.io:30080/callback
        Dex:
          Issuer: https://auth.keyolk.cluster.io:30443
          Connector:
            GitHub:
              Name: "GitHub"
              ClientId: ODAyOWM3MWNiYjRmNmFkOGZmZGE=
              ClientSecret: NTE5YzRlODg0NDI3MTBhZDJmMGM0YWE1NDBjNjgyZTNlNDY4YWEzZg==
            Oidc:
              Issuer: https://accounts.google.com
              ClientId: ODc2MDc2NjM5NDQ0LW8zdTIzZjY5ZGlsdXMxYTBkNzd0ZHQxb3FzMWZpaDViLmFwcHMuZ29vZ2xldXNlcmNvbnRlbnQuY29t
              ClientSecret: T0pMc0FLeUpsY2ZjaUtnbkhzaHVwZjQ4
            Ldap:
              Name: "LDAP"
              Host: "openldap:389"
              InsecureNoSsl: true
              InsecureSkipVerify: true
              BindDn: "cn=admin,dc=local,dc=io"
              BindPw: "admin"
              UserSearch:
                BaseDn: "ou=users,dc=local,dc=io"
                Filter: "(objectClass=posixAccount)"
                Username: "uid"
                IdAttr: "uid"
                EmailAttr: "mail"
                NameAttr: "uid"
              GroupSearch:
                BaseDn: "ou=groups,dc=local,dc=io"
                Filter: "(objectClass=posixGroup)"
                UserAttr: "uid"
                GroupAttr: "memberUid"
                NameAttr: "cn"
  readiness:
    type: exact
    value: 0
    wait: 600
        DexApp:
          RedirectUri: http://auth.keyolk.cluster.io:30080/callback
```

The service 'dex' is oidc provider for kube-apiserver.
It has two endpoint which user should access, 'Dex' and 'DexApp'.
It should be accessible from user side but also cluster inside.

The service 'openldap' is used for authentication backend of 'dex'.

## Endpoints
By default, it exposes ports 30443, 30080 for 'dex'.
User should use same URI which defined in config.yaml.
And a port 31080 also exposed for phpLDAPadmin which included in 'openldap'.

To access there, following ingress configuration is required.
```yaml
deployment:
  providerConfig:
    ingressSecurity:
      -
        from_port: 30080
        to_port: 30080
        protocol: "TCP"
        cidr_blocks: ["0.0.0.0/0"]
      -
        from_port: 30443
        to_port: 30443
        protocol: "TCP"
        cidr_blocks: ["0.0.0.0/0"]
      -
        from_port: 31080
        to_port: 31080
        protocol: "TCP"
        cidr_blocks: ["0.0.0.0/0"]
```
## LDAP
Following LDAP configuration is suitable with the config.yaml defined top.
Commented line is done when openldap is deployed.
```lidf
# LDIF Export for dc=local,dc=io
# Server: localhost (localhost)
# Search Scope: sub
# Search Filter: (objectClass=*)
# Total Entries: 6
#
# Generated by phpLDAPadmin (http://phpldapadmin.sourceforge.net) on December 15, 2016 11:06 pm
# Version: 1.2.3

#version: 1

# Entry 1: dc=local,dc=io
# dn: dc=local,dc=io
# dc: local
# o: Example Inc.
# objectclass: top
# objectclass: dcObject
# objectclass: organization

# Entry 2: cn=admin,dc=local,dc=io
# dn: cn=admin,dc=local,dc=io
# cn: admin
# description: LDAP administrator
# objectclass: simpleSecurityObject
# objectclass: organizationalRole
# userpassword: admin

# Entry 3: ou=groups,dc=local,dc=io
dn: ou=groups,dc=local,dc=io
objectclass: organizationalUnit
objectclass: top
ou: groups

# Entry 4: cn=cnct,ou=groups,dc=local,dc=io
dn: cn=cnct,ou=groups,dc=local,dc=io
cn: cnct
gidnumber: 500
memberuid: keyolk
objectclass: posixGroup
objectclass: top

# Entry 5: ou=users,dc=local,dc=io
dn: ou=users,dc=local,dc=io
objectclass: organizationalUnit
objectclass: top
ou: users

# Entry 6: uid=keyolk,ou=users,dc=local,dc=io
dn: uid=keyolk,ou=users,dc=local,dc=io
cn: keyolk
gidnumber: 500
givenname: chanhun
homedirectory: /home/keyolk
mail: keyolk@gmail.com
mobile: 010-6350-5811
objectclass: inetOrgPerson
objectclass: top
objectclass: posixAccount
pager: cn=admin,dc=local,dc=io
sn: keyolk
uid: keyolk
uidnumber: 1000
userpassword: secret
```
It has one group with one user.
The user 'keyolk' has password 'secret'

Let's see LDAP connector configuration again.
```yaml
Ldap:
  Name: "LDAP"
  Host: "openldap:389"
  InsecureNoSsl: true
  InsecureSkipVerify: true
  BindDn: "cn=admin,dc=local,dc=io"
  BindPw: "admin"
  UserSearch:
    BaseDn: "ou=users,dc=local,dc=io"
    Filter: "(objectClass=posixAccount)"
    Username: "uid"
    IdAttr: "uid"
    EmailAttr: "mail"
    NameAttr: "uid"
  GroupSearch:
    BaseDn: "ou=groups,dc=local,dc=io"
    Filter: "(objectClass=posixGroup)"
    UserAttr: "uid"
    GroupAttr: "memberUid"
    NameAttr: "cn"
```

about parameters,
- Ldap
  - BindDn : The DN and password for an application service account. The connector uses
  - BindPW: these credentials to search for users and groups. Not required if the LDAP server provides access for anonymous auth.
  - UserSearch:
    - BaseDN: BaseDN to start the search from. It will translate to the query
    - Filter: Optional filter to apply when searching the directory.
    - Username: Attribute used for comparing user entries. This will be translated and combined with the other filter as '(<attr>=<username>)'.
    - IdAttr: String representation of the user.
    - EmailAttr: Required. Attribute to map to Email.
    - NameAttr: Maps to display name of users. No default value.
  - GroupSearch:
    - BaseDn: BaseDN to start the search from. It will translate to the query '(&(objectClass=group)(member=<user uid>))'.
    - Filter: Optional filter to apply when searching the directory.
    - UserAttr/GroupAttr: Used to match a user to a group. It adds an additional requirement to the filter that an attribute in the group must match the user's attribute value.
    - NameAttr: Represents group name.

You can confirm whether search function work or not
using below info with phpLDAPadmin.
```bash
BaseDN: ou=users,dc=local,dc=io
Filter: (&(objectClass=posixAccount)(uid=keyolk))
ShowAttribute: uid, mail

DN: ou=groups,dc=local,dc=io
Filter: (&(objectClass=posixGroup)(memberUid=keyolk))
ShowAttribute: cn, gidNumber, memberUid
```

From here the informations above is used by kube-apiserver with below flags.
```bash
--oidc-issuer-url=https://auth.keyolk.cluster.io:30443
--oidc-client-id=example-app
--oidc-ca-file=/etc/kubernetes/ssl/ca.pem
--oidc-username-claim=email
--oidc-groups-claim=groups
--oidc-client-id=example-app
--oidc-ca-file=/etc/kubernetes/ssl/ca.pem
--oidc-username-claim=email
```

## Login
To login, access to 'DexApp' first from browser.
Here assume its URL http://auth.keyolk.cluster.io:30080
![login_1](image/login_1.png)
Make sure here, extra scopes filed has 'groups' it be used for gropu authentication.

![login_2](image/login_2.png)
Choose LDAP

![login_3](image/login_3.png)
keyolk / secret

![login_4](image/login_4.png)
The token here is used.

```bash
$ token="eyJhbGciOiJSUzI1NiIsImtpZCI6IjNkYzU2YmE0ZWQ2OWNkNGRmZjE2MjdlYWU5NGY2ZThhZmU2NDA5OWIifQ.eyJpc3MiOiJodHRwczovL2RleC5rZXlvbGsua3ViZS5jbHVzdGVyLmlvOjMwNDQzIiwic3ViIjoia2V5b2xrIiwiYXVkIjoiZXhhbXBsZS1hcHAiLCJleHAiOjE0ODM4MzA2NjMsImlhdCI6MTQ4Mzc0NDI2MywiZW1haWwiOiJrZXlvbGtAZ21haWwuY29tIiwiZW1haWxfdmVyaWZpZWQiOmZhbHNlLCJncm91cHMiOlsiY25jdCJdLCJuYW1lIjoia2V5b2xrIn0.qA36iIEIEv3dt22-XldBef0fiM-PqTtuc4BwWUK6E8tK9y3zk8OraoGgqKhLYn2v4hspocYhSC1OXUsj9ShwAKM_Gb-2-5LA8URiTVwtX1MTlF5CkS3f6kX8erX_mGWSURZCoMPf1eiPX814DfIG4U4ApqlJNowCyaXelc3hUQSaATN3hYHYBNlgy0qdiP_QLuZGDbemcgLXUGWeZJad8Yzl6Vg1ub1AfdP50R-YEeMw77pzdyMPu3nOS8jxavCtL1l07GVOqMWg4s4-Z4COCCn8SQbdi9rMmN8Lski6t0jdbcM2l6ag4Dr_tlIpA_pMPoSKmH1Y7BPNfBUcdC7oOA"

$ kubectl config set-credentials dex --token=$token
$ kubectl config set-context dex --namespace=kube-auth --user=dex
$ kubectl config use-context dex

$ kubectl get node
NAME                                         STATUS                     AGE
ip-10-0-101-31.us-west-2.compute.internal    Ready,SchedulingDisabled   2h
ip-10-0-126-57.us-west-2.compute.internal    Ready                      2h
ip-10-0-127-34.us-west-2.compute.internal    Ready                      2h
ip-10-0-150-133.us-west-2.compute.internal   Ready,SchedulingDisabled   2h
ip-10-0-17-58.us-west-2.compute.internal     Ready                      2h
ip-10-0-177-165.us-west-2.compute.internal   Ready                      2h
ip-10-0-36-152.us-west-2.compute.internal    Ready,SchedulingDisabled   2h
ip-10-0-55-64.us-west-2.compute.internal     Ready                      2h

```

To make it simple without browser you can use below script instead.
```bash
#!/bin/bash

DEX_URI=https://auth.keyolk.cluster.io:30443
DEX_CLIENT_REDIRECT_URI=http://auth.keyolk.cluster.io:30080/callback
DEX_CLIENT_ID=example-app
DEX_AUTH_CONNECTOR=ldap
KUBE_CONFIG=~/.kraken/keyolk/admin.kubeconfig
KUBE_CLUSTER=keyolk
KUBE_NAMESPACE=cnct
KUBE_USER=keyolk

request=/auth
params="client_id=$DEX_CLIENT_ID"
params="$params redirect_uri=$DEX_CLIENT_REDIRECT_URI"
params="$params response_type=code"
params="$params scope=groups+openid+profile+email+offline_access"
params=($params)
params=`printf "%s&" "${params[@]}"`

echo -e "\nYour token request is :"
echo ${DEX_URI}${request}?${params}

api=`curl -skL ${DEX_URI}${request}?${params} \
  | grep req | grep -i $DEX_AUTH_CONNECTOR \
  | awk -F'=' -F'"' '{print $2}'`

echo -e "\nInput your login info."
read -p 'Username: ' username
read -sp 'Password: ' password

echo -e "\nYour token is : "
token=`curl -skL \
  --data "login=$username&password=$password" \
  ${DEX_URI}${api} \
  | grep "<p> Token:" \
  | awk -F'code>' '{print $2}' | cut -d '<' -f 1`

echo $token

echo -e "\nSet the token to given kubeConfig file : $KUBE_CONFIG"

kubectl --kubeconfig $KUBE_CONFIG config set-credentials $KUBE_USER --token=$token
kubectl --kubeconfig $KUBE_CONFIG config set-context $KUBE_USER --cluster=$KUBE_CLUSTER --namespace=$KUBE_NAMESPACE --user=$KUBE_USER
kubectl --kubeconfig $KUBE_CONFIG config use-context $KUBE_USER
```

Then use it like below
```bash
$ ./login.sh

Your token request is :
https://auth.keyolk.cluster.io:30443/auth?client_id=example-app&redirect_uri=http://auth.keyolk.cluster.io:30080/callback&response_type=code&scope=groups+openid+profile+email+offline_access&

Input your login info.
Username: keyolk
Password:
Your token is :
eyJhbGciOiJSUzI1NiIsImtpZCI6ImI5MGUxMTBjYTY2MzZmM2QyYzA4OTVmZjk0NjUwNmIyM2YxZGQwMjQifQ.eyJpc3MiOiJodHRwczovL2F1dGgua2V5b2xrLmNsdXN0ZXIuaW86MzA0NDMiLCJzdWIiOiJrZXlvbGsiLCJhdWQiOiJleGFtcGxlLWFwcCIsImV4cCI6MTQ4NDMzNjU1NSwiaWF0IjoxNDg0MjUwMTU1LCJlbWFpbCI6ImtleW9sa0BnbWFpbC5jb20iLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsImdyb3VwcyI6WyJjbmN0Il0sIm5hbWUiOiJrZXlvbGsifQ.HAGhU8U0Wao2qnzhSaYqzxvrrWhR3INWEjMRNvUY9ufTy-Ie42TjWL2NT2ahQbSyrFnD3ZK0PKYv8Mf86MZf0g15I7UKzJUNdodqkVxSw_BJHswnlKcrbgxs89AdiLouZ2MpanNFXaQX25SMP1BOgpyV8kvYXS2XtB13LWCMi-uVrd6azZj0_6kBYaGoGhp8Vg9GKDjLVazUFhaCk2G14sIewWpwTB4HG7gitisvjdXZioolg41KBsQw_yooe7eihM3WQlyoL1KByYmv3exS1VNkT7j73kyAjiLJPQvEbM4wNSa_wTro0SHJLT6wuzfgbNgu_Tfvqj9qr1bcEp6G_Q

Set the token to given kubeConfig file : /home/keyolk/.kraken/keyolk/admin.kubeconfig
user "dex" set.
context "dex" set.
switched to context "dex".

```

## RBAC
It succeed to login but cant have proper right to access kube-apsierver yet.
Check it.

```bash
$ kubectl get pod
the server does not allow access to the requested resource (get pods)
$ kubectl get svc
NAME             CLUSTER-IP      EXTERNAL-IP   PORT(S)           AGE
dex              10.36.38.132    <nodes>       443/TCP           2h
dex-app          10.32.55.77     <nodes>       80/TCP            2h
openldap         10.34.87.98     <none>        389/TCP,636/TCP   2h
openldap-admin   10.36.175.105   <nodes>       80/TCP            2h
```

It can get service info, but not pod info.
Cause k2 assign below policy default.

```yaml
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1alpha1
metadata:
  name: default
rules:
  - apiGroups: [""]
    resources:
      - componentstatuses
      - events
      - endpoints
      - namespaces
      - nodes
      - persistentvolumes
      - resourcequotas
      - services
    verbs: ["get", "watch", "list"]
  - nonResourceURLs: ["*"]
    verbs: ["get", "watch", "list"]
```

To provide its access right for its namespace, create belows
```
---
kind: Namespace
apiVersion: v1
metadata:
  name: cnct
---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1alpha1
metadata:
  namespace: cnct
  name: cnct
rules:
  - apiGroups: ["*"]
    resources: ["*"]
    verbs: ["*"]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1alpha1
metadata:
  name: cnct
  namespace: cnct
subjects:
  - kind: Group
    name: cnct
    namespace: cnct
roleRef:
  kind: Role
  namespace: cnct
  name: cnct
  apiVersion: rbac.authorization.k8s.io/v1alpha1
```

Now it can create deploy to its namespace.
```bash
$ kubectl run tomcat --image=tomcat --namespace=cnct
deployment "tomcat" created

$ kubectl get pod --namespace=cnct
NAME                      READY     STATUS              RESTARTS   AGE
tomcat-1609341292-8qdbm   0/1       ContainerCreating   0          7s
```

## ToDo
#### Configuration
1. Certificates
To use dex for auth, passing dex's ca certificates is required.
But there is size limitation using cloud-init with AWS.
Now it just use same CA what kube apiserver uses.
Need another channel for passing it from given services to each VM instances.

And to find/set dex'services configuration like issuer URL.
From now K2 just assume that it is located under 'values.Dex.Issuer'
The path is hard coded under kraken.config. Should be changed.

2. Ingress
The services dex, dex-app need to expose their service.
Currently It uses NodePort but seems it better to change to use IngressController.
Also proper configuration also required for config.yaml.

#### Login from CLI
Currently kubectl doens has feature like 'login'.
This implementation on k2 is not convenient yet.
Need to setting JWT token to kubectl manually.
There is workaround script but not good so.
Better reimplement DexApp and create a feature to kubecli to get auth token and set it given kubeconfig.

#### Auto sync RBAC and LDAP
When new LDAP objects is registerd, related user or group's RBAC resources should be created.
